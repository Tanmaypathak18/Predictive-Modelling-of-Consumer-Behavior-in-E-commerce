<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Discount Optimization Engine</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --warning: #f39c12; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        
        /* Header */
        .header { grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 1.6em; color: var(--primary); }
        .input-group { display: flex; gap: 10px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 280px; }
        button { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }

        /* Sidebar - Profile */
        .sidebar { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: fit-content; }
        .sidebar h3 { margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .profile-table td { padding: 8px 0; border-bottom: 1px solid #eee; font-size: 0.9em; }
        .profile-table td:first-child { color: #7f8c8d; font-weight: 600; }
        .profile-table td:last-child { text-align: right; font-weight: bold; color: #2c3e50; }

        /* Main Content */
        .main { display: flex; flex-direction: column; gap: 20px; }
        
        /* Metrics Cards */
        .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .card-title { font-size: 0.85em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }
        .card-value { font-size: 1.8em; font-weight: 800; color: var(--primary); margin: 10px 0; }
        .small-tag { font-size: 0.8em; padding: 3px 8px; border-radius: 10px; background: #eee; color: #555; }
        
        /* Charts Area */
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .chart-title { font-weight: bold; margin-bottom: 15px; display: block; color: var(--primary); }
        img { max-width: 100%; height: auto; border-radius: 8px; }

        /* Waterfall Chart (CSS) */
        .waterfall { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .bar-row { display: flex; align-items: center; font-size: 0.9em; }
        .bar-label { width: 40%; text-align: right; padding-right: 10px; }
        .bar-area { width: 60%; display: flex; align-items: center; }
        .bar { height: 20px; border-radius: 3px; }
        .bar.positive { background: var(--success); }
        .bar.negative { background: #e74c3c; }
        .bar.base { background: #95a5a6; }
        
        /* Table */
        .table-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        th { text-align: left; background: #f8f9fa; padding: 10px; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr.active-row { background: #e8f8f5; font-weight: bold; }
        
        .loading { text-align: center; padding: 40px; display: none; grid-column: 1 / -1; }
        .sample-code { cursor: pointer; color: var(--accent); background: #eef; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <div>
                <h1>AI-Powered Discount Optimization Engine</h1>
                <small style="color:#7f8c8d;">Try ID: <span class="sample-code" onclick="fillUser('d9dca3cb44bab12ba313eaa681f663eb')">d9dca3...</span></small>
            </div>
            <div class="input-group">
                <input type="text" id="userId" placeholder="Enter User ID Hash">
                <button onclick="optimize()">Generate Strategy ðŸš€</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <i class="fas fa-circle-notch fa-spin fa-2x" style="color: var(--accent);"></i><br><br>Running XGBoost Simulation...
        </div>

        <div class="sidebar" id="sidebar" style="display:none;">
            <h3>ðŸ‘¤ Decision Context</h3>
            <table class="profile-table">
                <tr><td>Location</td><td id="uLoc">--</td></tr>
                <tr><td>Demographics</td><td id="uDemo">--</td></tr>
                <tr><td>Total Visits</td><td id="uVisits">--</td></tr>
                <tr><td>Conversion Rate</td><td id="uConv">--</td></tr>
                <tr><td>Last Item Price</td><td id="uPrice">--</td></tr>
            </table>
            <br>
            <h3>ðŸ“Š AI Logic</h3>
            <p style="font-size:0.9em; color:#666;">
                The model analyzed <strong>240+ features</strong> to make this decision. The waterfall chart below shows the top factors pushing the probability up (Green) or down (Red).
            </p>
        </div>

        <div class="main" id="main" style="display:none;">
            
            <div class="cards">
                <div class="card" style="border-top: 4px solid #3498db;">
                    <div class="card-title">Recommended Discount</div>
                    <div class="card-value" id="recDiscount">--%</div>
                    <span class="small-tag" id="recSegment">--</span>
                </div>
                <div class="card" style="border-top: 4px solid #f39c12;">
                    <div class="card-title">Price Elasticity</div>
                    <div class="card-value" id="recElasticity">0.0</div>
                    <span class="small-tag">Sensitivity Score</span>
                </div>
                <div class="card" style="border-top: 4px solid #27ae60;">
                    <div class="card-title">Expected Profit</div>
                    <div class="card-value" id="recProfit">Â¥0</div>
                    <span class="small-tag">Per Unit</span>
                </div>
                <div class="card" style="border-top: 4px solid #e74c3c;">
                    <div class="card-title">AI Uplift</div>
                    <div class="card-value" id="recUplift">+Â¥0</div>
                    <span class="small-tag">vs. Standard Strategy</span>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-box">
                    <span class="chart-title">Profit Optimization Surface</span>
                    <img id="chartImg" src="" alt="Curve" />
                </div>
                <div class="chart-box">
                    <span class="chart-title">Feature Impact Waterfall</span>
                    <div id="waterfall" class="waterfall">
                        </div>
                </div>
            </div>

            <div class="table-box">
                <span class="chart-title">Simulation Data</span>
                <table>
                    <thead>
                        <tr>
                            <th>Discount</th>
                            <th>Win Probability</th>
                            <th>Revenue</th>
                            <th>Exp. Profit</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="simTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "http://127.0.0.1:8000";

        function fillUser(id) { document.getElementById('userId').value = id; }

        async function optimize() {
            const userId = document.getElementById('userId').value;
            if (!userId) return alert("Please enter a User ID");

            document.getElementById('loading').style.display = 'block';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('main').style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/find_best_discount/${userId}`);
                if (!res.ok) throw new Error("API Error");
                const data = await res.json();

                // 1. Populate Context Sidebar
                document.getElementById('uLoc').innerText = data.decision_context.location;
                document.getElementById('uDemo').innerText = data.decision_context.age + " / " + data.decision_context.gender;
                document.getElementById('uVisits').innerText = data.decision_context.total_visits;
                document.getElementById('uConv').innerText = data.decision_context.conversion_rate;
                document.getElementById('uPrice').innerText = data.decision_context.catalog_price;

                // 2. Populate Cards
                document.getElementById('recDiscount').innerText = data.recommendation;
                document.getElementById('recSegment').innerText = data.segment;
                document.getElementById('recElasticity').innerText = data.elasticity_score;
                document.getElementById('recProfit').innerText = "Â¥" + data.financials.expected_profit;
                
                const uplift = data.financials.uplift_vs_10pct;
                const upEl = document.getElementById('recUplift');
                upEl.innerText = (uplift >= 0 ? "+" : "") + "Â¥" + uplift;
                upEl.style.color = uplift >= 0 ? "#27ae60" : "#e74c3c";

                // 3. Charts
                document.getElementById('chartImg').src = `${API_URL}/get_discount_curve/${userId}?t=${Date.now()}`;
                
                // 4. Build Waterfall
                const wf = document.getElementById('waterfall');
                wf.innerHTML = "";
                data.feature_impacts.forEach(feat => {
                    const width = Math.abs(feat.value) * 100 * 3; // Scale factor
                    const colorClass = feat.type; // positive, negative, base
                    wf.innerHTML += `
                        <div class="bar-row">
                            <div class="bar-label">${feat.name}</div>
                            <div class="bar-area">
                                <div class="bar ${colorClass}" style="width: ${width}px;"></div>
                                <span style="margin-left:5px; font-size:0.8em;">${feat.value > 0 ? '+' : ''}${feat.value}</span>
                            </div>
                        </div>
                    `;
                });

                // 5. Build Table
                const tbody = document.getElementById('simTableBody');
                tbody.innerHTML = "";
                data.simulation_curve.forEach(row => {
                    const isBest = (row.discount + "% Discount") === data.recommendation;
                    const tr = document.createElement('tr');
                    if(isBest) tr.classList.add('active-row');
                    tr.innerHTML = `
                        <td>${row.discount}%</td>
                        <td>${(row.probability*100).toFixed(1)}%</td>
                        <td>Â¥${(data.decision_context.catalog_price.replace('Â¥','') * (1-row.discount/100)).toFixed(0)}</td>
                        <td>Â¥${row.expected_profit}</td>
                        <td>${isBest ? 'âœ… Recommended' : ''}</td>
                    `;
                    tbody.appendChild(tr);
                });

                document.getElementById('sidebar').style.display = 'block';
                document.getElementById('main').style.display = 'flex';

            } catch (err) {
                console.error(err);
                alert("Error connecting to API. Make sure it's running!");
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>